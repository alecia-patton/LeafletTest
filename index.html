<!DOCTYPE html>

<html>
	<!--
	Leaflet Map

	-->
	<head>

		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
		<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
		<![endif]-->
		<style type="text/css">
			body {
				padding: 0;
				margin: 0;
			}

			html, body, #mapDiv {
				height: 100%;
			}

		</style>

		<link rel="stylesheet" href="https://cdn.rawgit.com/stefanocudini/leaflet-search/master/dist/leaflet-search.src.css"/>
		<script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
		<script src="https://cdn.rawgit.com/calvinmetcalf/leaflet-ajax/master/dist/leaflet.ajax.min.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/stefanocudini/leaflet-search/master/dist/leaflet-search.src.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/alecia-patton/LeafletTest/master/Control.OSMGeocoder.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/alecia-patton/LeafletTest/master/leaflet.ajax.min.js"></script>
	</head>
	<body>
		<div id="mapDiv"></div>
		<script>
			var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				attribution : '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			});

			function popUpgravitypipe(feature, layer) {
				layer.bindPopup("<b>ID: </b> " + feature.properties.id + "<br><b>Old ID: </b>" + feature.properties.oldpipeid);
			}

			var gravitypipe = new L.GeoJSON.AJAX('https://cdn.rawgit.com/alecia-patton/LeafletTest/master/gravitypipe.geojson', {
				onEachFeature : popUpgravitypipe
			});

			function popUpmanholes(feature, layer) {
				layer.bindPopup("<b>ID: </b> " + feature.properties.mh_num + "<br><b>Old ID: </b>" + feature.properties.old_id);
			}

			var manholes = new L.GeoJSON.AJAX('https://cdn.rawgit.com/alecia-patton/LeafletTest/master/manholes.geojson', {
				onEachFeature : popUpmanholes
			});

			
			var map = L.map('mapDiv').setView([34.8703, -92.1153], 13);
			tiles.addTo(map);
			
			map.on('zoomend ', function(e) {
				if (map.getZoom() <= 17) {
					map.removeLayer(manholes)
				} else if (map.getZoom() > 17) {
					map.addLayer(manholes)
					var searchControl = new L.Control.Search({
				layer : manhole,
				propertyName : 'mh_num',
				circleLocation : false,
				zoom : 18
			});
			searchControl.on('search_locationfound', function(e) {

				//map.setView(e.properties.coordinates, 1);

				e.layer.setStyle({
					fillColor : '#3f0',
					color : '#0f0'
				});

			}).on('search_collapsed', function(e) {
				manhole.eachLayer(function(layer) {

					manhole.resetStyle(layer);
				});
			});
			map.addControl(searchControl);
				}
			});

			map.on('zoomend ', function(e) {
				if (map.getZoom() <= 17) {
					map.removeLayer(gravitypipe)
				} else if (map.getZoom() > 17) {
					map.addLayer(gravitypipe)
				}
			});

			var boundary = new L.LatLngBounds([[34.9703, -92.0153], [34.7703, -92.2153]]);
			var options = {
				collapsed : true,
				position : 'bottomright',
				text : 'Address',
				placeholder : 'Search...',
				showResultIcons : true,
				bounds : boundary,
				email : null,
				callback : function(results) {
					var bbox = results[0].boundingbox, first = new L.LatLng(bbox[0], bbox[2]), second = new L.LatLng(bbox[1], bbox[3]), bounds = new L.LatLngBounds([first, second]);
					this._map.fitBounds(bounds);
				}
			};

			var osmGeocoder = new L.Control.OSMGeocoder(options);
			map.addControl(osmGeocoder);
			

			var overlays = {
				"Gravity Pipe" : gravitypipe,
				"Manholes" : manholes
			};

			L.control.layers("", overlays).addTo(map);

		</script>
	</body>
</html>
