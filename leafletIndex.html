<!doctype html>
<html>
	<head>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
		<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
		<![endif]-->
		<style type="text/css">
			body {
				padding: 0;
				margin: 0;
			}

			html, body, #cupcake-map {
				height: 100%;
			}

		</style>
		<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>

		<style type="text/css">
			.leaflet-control-geocoder a {
				background-position: 50% 50%;
				background-repeat: no-repeat;
				display: block;
			}

			.leaflet-control-geocoder {
				box-shadow: 0 1px 7px #999;
				background: #f8f8f9;
				-moz-border-radius: 8px;
				-webkit-border-radius: 8px;
				border-radius: 8px;
			} 

			.leaflet-control-geocoder a {
				background-image: url(images/geocoder.png);
				width: 36px;
				height: 36px;
			}

			.leaflet-touch .leaflet-control-geocoder a {
				width: 44px;
				height: 44px;
			}

			.leaflet-control-geocoder .leaflet-control-geocoder-form, .leaflet-control-geocoder-expanded .leaflet-control-geocoder-toggle {
				display: none;
			}

			.leaflet-control-geocoder-expanded .leaflet-control-geocoder-form {
				display: block;
				position: relative;
			}

			.leaflet-control-geocoder-expanded .leaflet-control-geocoder-form {
				padding: 5px;
			}

		</style>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	</head>
	<body>
		<div id="cupcake-map"></div>
		<script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>

		<script type="text/javascript">//OSMGeocoder
			if ( typeof console == "undefined") {
				this.console = {
					log : function(msg) {/* do nothing since it would otherwise break IE */
					}
				};
			}

			L.Control.OSMGeocoder = L.Control.extend({
				options : {
					collapsed : true,
					position : 'topright',
					text : 'Locate',
					bounds : null, // L.LatLngBounds
					email : null, // String
					callback : function(results) {
						if (results.length == 0) {
							console.log("ERROR: didn't find a result");
							return;
						}
						var bbox = results[0].boundingbox, first = new L.LatLng(bbox[0], bbox[2]), second = new L.LatLng(bbox[1], bbox[3]), bounds = new L.LatLngBounds([first, second]);
						this._map.fitBounds(bounds);
					}
				},

				_callbackId : 0,

				initialize : function(options) {
					L.Util.setOptions(this, options);
				},

				onAdd : function(map) {
					this._map = map;

					var className = 'leaflet-control-geocoder', container = this._container = L.DomUtil.create('div', className);

					L.DomEvent.disableClickPropagation(container);

					var form = this._form = L.DomUtil.create('form', className + '-form');

					var input = this._input = document.createElement('input');
					input.type = "text";

					var submit = document.createElement('input');
					submit.type = "submit";
					submit.value = this.options.text;

					form.appendChild(input);
					form.appendChild(submit);

					L.DomEvent.addListener(form, 'submit', this._geocode, this);

					if (this.options.collapsed) {
						L.DomEvent.addListener(container, 'mouseover', this._expand, this);
						L.DomEvent.addListener(container, 'mouseout', this._collapse, this);

						var link = this._layersLink = L.DomUtil.create('a', className + '-toggle', container);
						link.href = '#';
						link.title = 'Nominatim Geocoder';

						L.DomEvent.addListener(link, L.Browser.touch ? 'click' : 'focus', this._expand, this);

						this._map.on('movestart', this._collapse, this);
					} else {
						this._expand();
					}

					container.appendChild(form);

					return container;
				},

				/* helper functions for cordinate extraction */
				_createSearchResult : function(lat, lon) {
					//creates an position description similar to the result of a Nominatim search
					var diff = 0.005;
					var result = [];
					result[0] = {};
					result[0]["boundingbox"] = [parseFloat(lat) - diff, parseFloat(lat) + diff, parseFloat(lon) - diff, parseFloat(lon) + diff];
					result[0]["class"] = "boundary";
					result[0]["display_name"] = "Position: " + lat + " " + lon;
					result[0]["lat"] = lat;
					result[0]["lon"] = lon;
					return result;
				},
				_isLatLon : function(q) {
					//"lon lat" => xx.xxx x.xxxxx
					var re = /(-?\d+\.\d+)\s(-?\d+\.\d+)/;
					var m = re.exec(q);
					if (m != undefined)
						return m;

					//lat...xx.xxx...lon...x.xxxxx
					re = /lat\D*(-?\d+\.\d+)\D*lon\D*(-?\d+\.\d+)/;
					m = re.exec(q);
					//showRegExpResult(m);
					if (m != undefined)
						return m;
					else
						return null;
				},
				_isLatLon_decMin : function(q) {
					console.log("is LatLon?: " + q);
					//N 53° 13.785' E 010° 23.887'
					//re = /[NS]\s*(\d+)\D*(\d+\.\d+).?\s*[EW]\s*(\d+)\D*(\d+\.\d+)\D*/;
					re = /([ns])\s*(\d+)\D*(\d+\.\d+).?\s*([ew])\s*(\d+)\D*(\d+\.\d+)/i;
					m = re.exec(q.toLowerCase());
					//showRegExpResult(m);
					if ((m != undefined))
						return m;
					else
						return null;
					// +- dec min +- dec min
				},

				_geocode : function(event) {
					L.DomEvent.preventDefault(event);
					var q = this._input.value;
					//try to find corrdinates
					if (this._isLatLon(q) != null) {
						var m = this._isLatLon(q);
						console.log("LatLon: " + m[1] + " " + m[2]);
						//m = {lon, lat}
						this.options.callback.call(this, this._createSearchResult(m[1], m[2]));
						return;
					} else if (this._isLatLon_decMin(q) != null) {
						var m = this._isLatLon_decMin(q);
						//m: [ns, lat dec, lat min, ew, lon dec, lon min]
						var temp = new Array();
						temp['n'] = 1;
						temp['s'] = -1;
						temp['e'] = 1;
						temp['w'] = -1;
						this.options.callback.call(this, this._createSearchResult(temp[m[1]] * (Number(m[2]) + m[3] / 60), temp[m[4]] * (Number(m[5]) + m[6] / 60)));
						return;
					}

					//and now Nominatim
					//http://wiki.openstreetmap.org/wiki/Nominatim
					console.log(this._callbackId);
					window[("_l_osmgeocoder_" + this._callbackId)] = L.Util.bind(this.options.callback, this);

					/* Set up params to send to Nominatim */
					var params = {
						// Defaults
						q : this._input.value,
						json_callback : ("_l_osmgeocoder_" + this._callbackId++),
						format : 'json'
					};

					if (this.options.bounds && this.options.bounds != null) {
						if (this.options.bounds instanceof L.LatLngBounds) {
							params.viewbox = this.options.bounds.toBBoxString();
							params.bounded = 1;
						} else {
							console.log('bounds must be of type L.LatLngBounds');
							return;
						}
					}

					if (this.options.email && this.options.email != null) {
						if ( typeof this.options.email == 'string') {
							params.email = this.options.email;
						} else {
							console.log('email must be a string');
						}
					}

					var url = " http://nominatim.openstreetmap.org/search" + L.Util.getParamString(params), script = document.createElement("script");

					script.type = "text/javascript";
					script.src = url;
					script.id = this._callbackId;
					document.getElementsByTagName("head")[0].appendChild(script);
				},

				_expand : function() {
					L.DomUtil.addClass(this._container, 'leaflet-control-geocoder-expanded');
				},

				_collapse : function() {
					this._container.className = this._container.className.replace(' leaflet-control-geocoder-expanded', '');
				}
			});

		</script>

		<script type="text/javascript">//AJAX

			! function() {
				function a(b, c, d) {
					var e = a.resolve(b);
					if (null == e) {
						d = d || b, c = c || "root";
						var f = new Error('Failed to require "' + d + '" from "' + c + '"');
						throw f.path = d, f.parent = c, f.require = !0, f
					}
					var g = a.modules[e];
					return g.exports || (g.exports = {}, g.client = g.component = !0, g.call(this, g.exports, a.relative(e), g)), g.exports
				}
				a.modules = {}, a.aliases = {}, a.resolve = function(b) {
					"/" === b.charAt(0) && ( b = b.slice(1));
					for (var c = [b, b + ".js", b + ".json", b + "/index.js", b + "/index.json"], d = 0; d < c.length; d++) {
						var b = c[d];
						if (a.modules.hasOwnProperty(b))
							return b;
						if (a.aliases.hasOwnProperty(b))
							return a.aliases[b]
					}
				}, a.normalize = function(a, b) {
					var c = [];
					if ("." != b.charAt(0))
						return b;
					a = a.split("/"), b = b.split("/");
					for (var d = 0; d < b.length; ++d)
						".." == b[d] ? a.pop() : "." != b[d] && "" != b[d] && c.push(b[d]);
					return a.concat(c).join("/")
				}, a.register = function(b, c) {
					a.modules[b] = c
				}, a.alias = function(b, c) {
					if (!a.modules.hasOwnProperty(b))
						throw new Error('Failed to alias "' + b + '", it does not exist');
					a.aliases[c] = b
				}, a.relative = function(b) {
					function c(a, b) {
						for (var c = a.length; c--; )
							if (a[c] === b)
								return c;
						return -1
					}

					function d(c) {
						var e = d.resolve(c);
						return a(e, b, c)
					}

					var e = a.normalize(b, "..");
					return d.resolve = function(d) {
						var f = d.charAt(0);
						if ("/" == f)
							return d.slice(1);
						if ("." == f)
							return a.normalize(e, d);
						var g = b.split("/"), h = c(g, "deps") + 1;
						return h || ( h = 0), d = g.slice(0, h + 1).join("/") + "/deps/" + d
					}, d.exists = function(b) {
						return a.modules.hasOwnProperty(d.resolve(b))
					}, d
				}, a.register("calvinmetcalf-setImmediate/lib/index.js", function(a, b, c) {"use strict";
					function d() {
						var a, b = 0, c = g;
						for ( g = []; a = c[b++]; )
							a()
					}

					var e, f = [b("./nextTick"), b("./mutation"), b("./postMessage"), b("./messageChannel"), b("./stateChange"), b("./timeout")], g = [];
					f.some(function(a) {
						var b = a.test();
						return b && ( e = a.install(d)), b
					});
					var h = function(a) {
						var b, c;
						return arguments.length > 1 && "function" == typeof a && ( c = Array.prototype.slice.call(arguments, 1), c.unshift(
						void 0), a = a.bind.apply(a, c)), 1 === ( b = g.push(a)) && e(d), b
					};
					h.clear = function(a) {
						return a <= g.length && (g[a - 1] = function() {
						}), this
					}, c.exports = h
				}), a.register("calvinmetcalf-setImmediate/lib/nextTick.js", function(a) {"use strict";
					a.test = function() {
						return "object" == typeof process && "[object process]" === Object.prototype.toString.call(process)
					}, a.install = function() {
						return process.nextTick
					}
				}), a.register("calvinmetcalf-setImmediate/lib/postMessage.js", function(a, b) {"use strict";
					var c = b("./global");
					a.test = function() {
						if (!c.postMessage || c.importScripts)
							return !1;
						var a = !0, b = c.onmessage;
						return c.onmessage = function() {
							a = !1
						}, c.postMessage("", "*"), c.onmessage = b, a
					}, a.install = function(a) {
						function b(b) {
							b.source === c && b.data === d && a()
						}

						var d = "com.calvinmetcalf.setImmediate" + Math.random();
						return c.addEventListener ? c.addEventListener("message", b, !1) : c.attachEvent("onmessage", b),
						function() {
							c.postMessage(d, "*")
						}

					}
				}), a.register("calvinmetcalf-setImmediate/lib/messageChannel.js", function(a, b) {"use strict";
					var c = b("./global");
					a.test = function() {
						return !!c.MessageChannel
					}, a.install = function(a) {
						var b = new c.MessageChannel;
						return b.port1.onmessage = a,
						function() {
							b.port2.postMessage(0)
						}

					}
				}), a.register("calvinmetcalf-setImmediate/lib/stateChange.js", function(a, b) {"use strict";
					var c = b("./global");
					a.test = function() {
						return "document" in c && "onreadystatechange" in c.document.createElement("script")
					}, a.install = function(a) {
						return function() {
							var b = c.document.createElement("script");
							return b.onreadystatechange = function() {
								a(), b.onreadystatechange = null, b.parentNode.removeChild(b), b = null
							}, c.document.documentElement.appendChild(b), a
						}
					}
				}), a.register("calvinmetcalf-setImmediate/lib/timeout.js", function(a) {"use strict";
					a.test = function() {
						return !0
					}, a.install = function(a) {
						return function() {
							setTimeout(a, 0)
						}
					}
				}), a.register("calvinmetcalf-setImmediate/lib/global.js", function(a, b, c) {
					c.exports = "object" == typeof global && global ? global : this
				}), a.register("calvinmetcalf-setImmediate/lib/mutation.js", function(a, b) {"use strict";
					var c = b("./global"), d = c.MutationObserver || c.WebKitMutationObserver;
					a.test = function() {
						return d
					}, a.install = function(a) {
						var b = new d(a), e = c.document.createElement("div");
						return b.observe(e, {
							attributes : !0
						}), c.addEventListener("unload", function() {
							b.disconnect(), b = null
						}, !1),
						function() {
							e.setAttribute("drainQueue", "drainQueue")
						}

					}
				}), a.register("lie/lie.js", function(a, b, c) {
					function d(a) {
						function b(a, b) {
							return d(function(c, d) {
								k.push({
									resolve : a,
									reject : b,
									resolver : c,
									rejecter : d
								})
							})
						}

						function c(a, c) {
							return l ? l(a, c) : b(a, c)
						}

						function h(a, b) {
							for (var d, h, i = a ? "resolve" : "reject", j = 0, m = k.length; m > j; j++)
								d = k[j], h = d[i], "function" == typeof h ? g(f, h, b, d.resolver, d.rejecter) : a ? d.resolver(b) : d.rejecter(b);
							l = e(c, b, a)
						}

						function i(a) {
							l || h(!0, a)
						}

						function j(a) {
							l || h(!1, a)
						}

						if (!(this instanceof d))
							return new d(a);
						var k = [], l = !1;
						this.then = c;
						try {
							a(function(a) {
								a && "function" == typeof a.then ? a.then(i, j) : i(a)
							}, j)
						} catch(m) {
							j(m)
						}
					}

					function e(a, b, c) {
						return function(e, h) {
							var i = c ? e : h;
							return "function" != typeof i ? d(function(b, c) {
								a(b, c)
							}) : d(function(a, c) {
								g(f, i, b, a, c)
							})
						}
					}

					function f(a, b, c, d) {
						try {
							var e = a(b);
							e && "function" == typeof e.then ? e.then(c, d) : c(e)
						} catch(f) {
							d(f)
						}
					}

					var g = b("immediate");
					c.exports = d
				}), a.alias("calvinmetcalf-setImmediate/lib/index.js", "lie/deps/immediate/lib/index.js"), a.alias("calvinmetcalf-setImmediate/lib/nextTick.js", "lie/deps/immediate/lib/nextTick.js"), a.alias("calvinmetcalf-setImmediate/lib/postMessage.js", "lie/deps/immediate/lib/postMessage.js"), a.alias("calvinmetcalf-setImmediate/lib/messageChannel.js", "lie/deps/immediate/lib/messageChannel.js"), a.alias("calvinmetcalf-setImmediate/lib/stateChange.js", "lie/deps/immediate/lib/stateChange.js"), a.alias("calvinmetcalf-setImmediate/lib/timeout.js", "lie/deps/immediate/lib/timeout.js"), a.alias("calvinmetcalf-setImmediate/lib/global.js", "lie/deps/immediate/lib/global.js"), a.alias("calvinmetcalf-setImmediate/lib/mutation.js", "lie/deps/immediate/lib/mutation.js"), a.alias("calvinmetcalf-setImmediate/lib/index.js", "lie/deps/immediate/index.js"), a.alias("calvinmetcalf-setImmediate/lib/index.js", "immediate/index.js"), a.alias("calvinmetcalf-setImmediate/lib/index.js", "calvinmetcalf-setImmediate/index.js"), a.alias("lie/lie.js", "lie/index.js"), L.Util.Promise = a("lie")
			}(), L.Util.ajax = function(url, options) {"use strict";
				if ( options = options || {}, options.jsonp)
					return L.Util.ajax.jsonp(url, options);
				var request, cancel, out = L.Util.Promise(function(resolve, reject) {
					var Ajax;
					cancel = reject, Ajax =
					void 0 === window.XMLHttpRequest ? function() {
						try {
							return new ActiveXObject("Microsoft.XMLHTTP.6.0")
						} catch(a) {
							try {
								return new ActiveXObject("Microsoft.XMLHTTP.3.0")
							} catch(b) {
								reject("XMLHttpRequest is not supported")
							}
						}
					} : window.XMLHttpRequest;
					var response;
					request = new Ajax, request.open("GET", url), request.onreadystatechange = function() {
						4 === request.readyState && (request.status < 400 && options.local || 200 === request.status ? (window.JSON ? response = JSON.parse(request.responseText) : options.evil && ( response = eval("(" + request.responseText + ")")), resolve(response)) : request.status ? reject(request.statusText) : reject("Attempted cross origin request without CORS enabled"))
					}, request.send()
				});
				return out.then(null, function(a) {
					return request.abort(), a
				}), out.abort = cancel, out
			}, L.Util.jsonp = function(a, b) {
				b = b || {};
				var c, d, e, f, g = document.getElementsByTagName("head")[0], h = L.DomUtil.create("script", "", g), i = L.Util.Promise(function(i, j) {
					f = j;
					var k = b.cbParam || "callback";
					b.callbackName ? c = b.callbackName : ( e = "_" + ("" + Math.random()).slice(2), c = "L.Util.jsonp.cb." + e), h.type = "text/javascript", e && (L.Util.jsonp.cb[e] = function(a) {
						g.removeChild(h),
						delete L.Util.jsonp.cb[e], i(a)
					}), d = -1 === a.indexOf("?") ? a + "?" + k + "=" + c : a + "&" + k + "=" + c, h.src = d
				}).then(null, function(a) {
					return g.removeChild(h),
					delete L.Util.ajax.cb[e], a
				});
				return i.abort = f, i
			}, L.Util.jsonp.cb = {}, L.GeoJSON.AJAX = L.GeoJSON.extend({
				defaultAJAXparams : {
					dataType : "json",
					callbackParam : "callback",
					local : !1,
					middleware : function(a) {
						return a
					}
				},
				initialize : function(a, b) {
					this.urls = [], a && ("string" == typeof a ? this.urls.push(a) : "function" == typeof a.pop ? this.urls = this.urls.concat(a) : ( b = a, a =
					void 0));
					var c = L.Util.extend({}, this.defaultAJAXparams);
					for (var d in b)this.defaultAJAXparams.hasOwnProperty(d) && (c[d] = b[d]);
					this.ajaxParams = c, this._layers = {}, L.Util.setOptions(this, b), this.on("data:loaded", function() {
						this.filter && this.refilter(this.filter)
					}, this);
					var e = this;
					this.urls.length > 0 && L.Util.Promise(function(a) {
						a()
					}).then(function() {
						e.addUrl()
					})
				},
				clearLayers : function() {
					return this.urls = [], L.GeoJSON.prototype.clearLayers.call(this), this
				},
				addUrl : function(a) {
					var b = this;
					a && ("string" == typeof a ? b.urls.push(a) : "function" == typeof a.pop && (b.urls = b.urls.concat(a)));
					var c = b.urls.length, d = 0;
					b.fire("data:loading"), b.urls.forEach(function(a) {
						"json" === b.ajaxParams.dataType.toLowerCase() ? L.Util.ajax(a, b.ajaxParams).then(function(a) {
							var c = b.ajaxParams.middleware(a);
							b.addData(c), b.fire("data:progress", c)
						}, function(a) {
							b.fire("data:progress", {
								error : a
							})
						}) : "jsonp" === b.ajaxParams.dataType.toLowerCase() && L.Util.jsonp(a, b.ajaxParams).then(function(a) {
							var c = b.ajaxParams.middleware(a);
							b.addData(c), b.fire("data:progress", c)
						}, function(a) {
							b.fire("data:progress", {
								error : a
							})
						})
					}), b.on("data:progress", function() {
						++d === c && b.fire("data:loaded")
					})
				},
				refresh : function(a) {
					a = a || this.urls, this.clearLayers(), this.addUrl(a)
				},
				refilter : function(a) {
					"function" != typeof a ? (this.filter = !1, this.eachLayer(function(a) {
						a.setStyle({
							stroke : !0,
							clickable : !0
						})
					})) : (this.filter = a, this.eachLayer(function(b) {
						a(b.feature) ? b.setStyle({
							stroke : !0,
							clickable : !0
						}) : b.setStyle({
							stroke : !1,
							clickable : !1
						})
					}))
				}
			}), L.geoJson.ajax = function(a, b) {
				return new L.GeoJSON.AJAX(a, b)
			};

		</script>

		<script type="text/javascript">
			var cupcakeTiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				attribution : '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			});

			var map = L.map('cupcake-map').setView([34.8703, -92.1153], 13);
			
			var geojsonLayer = new L.GeoJSON.AJAX("https://cdn.rawgit.com/alecia-patton/LeafletTest/master/cupcakes.json");
			
			
			
			
			var boundary = new L.LatLngBounds([[34.9703, -92.0153], [34.7703, -92.2153]]);
			var options = {
				collapsed : false,
				position : 'bottomright',
				text : 'Address',
				placeholder : 'Search...',
				showResultIcons : true,
				bounds : boundary,
				email : null,
				callback : function(results) {
					var bbox = results[0].boundingbox, first = new L.LatLng(bbox[0], bbox[2]), second = new L.LatLng(bbox[1], bbox[3]), bounds = new L.LatLngBounds([first, second]);
					this._map.fitBounds(bounds);
				}
			};

			var osmGeocoder = new L.Control.OSMGeocoder(options);
			map.addControl(osmGeocoder);
			cupcakeTiles.addTo(map);
			geojsonLayer.addTo(map);

		</script>
	</body>
</html>

